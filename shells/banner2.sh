#!/usr/bin/env bash
# ä¸€é”®å®‰è£… Moreanp åŠ¨æ€ç™»å½• Bannerï¼ˆå®æ—¶åˆ·æ–°ï¼‰
# å½©è‰²è‰ºæœ¯å­—ä¿æŒåŸæ ·ï¼Œä¿¡æ¯æ¯3ç§’åˆ·æ–°

set -e

BANNER_PATH="/usr/local/bin/moreanp_banner.sh"

echo -e "\033[1;34m[ Moreanp Banner Installer ]\033[0m"
read -p "æ˜¯å¦å®‰è£… Moreanp ä¸“ç”¨åŠ¨æ€ Bannerï¼Ÿ(y/N): " CONFIRM
CONFIRM=${CONFIRM:-n}

if [[ ! "$CONFIRM" =~ ^[Yy]$ ]]; then
    echo "â å·²å–æ¶ˆå®‰è£…ã€‚"
    exit 0
fi

# =========================================================
# 1) ç”Ÿæˆ banner è„šæœ¬
# =========================================================
cat > "$BANNER_PATH" <<'EOF'
#!/usr/bin/env bash
# Moreanp åŠ¨æ€ Bannerï¼ˆå®æ—¶åˆ·æ–°ï¼‰
clear

while true; do
  # è·å–ç³»ç»Ÿä¿¡æ¯
  CPU=$(top -bn1 | awk '/Cpu\(s\)/ {printf "%.1f%%", 100 - $8}')
  MEM=$(free -m | awk '/Mem:/ {printf "%.1f%%", $3/$2*100}')
  DISK=$(df -h / | awk 'NR==2{print $5}')
  IP=$(curl -s --max-time 2 https://api.ipify.org || echo "N/A")

  # æ¸…å±
  clear

  # åŸå°ä¸åŠ¨è‰ºæœ¯å­—
  echo -e "[0;1;31;91mâ–„[0m    [0;1;36;96mâ–„[0m                                          "
  echo -e "[0;1;33;93mâ–ˆ[0;1;32;92mâ–ˆ[0m  [0;1;36;96mâ–ˆ[0;1;34;94mâ–ˆ[0m  [0;1;35;95mâ–„[0;1;31;91mâ–„â–„[0m    [0;1;36;96mâ–„[0m [0;1;34;94mâ–„â–„[0m   [0;1;31;91mâ–„[0;1;33;93mâ–„â–„[0m    [0;1;34;94mâ–„â–„[0;1;35;95mâ–„[0m   [0;1;33;93mâ–„[0m [0;1;32;92mâ–„â–„[0m   [0;1;34;94mâ–„[0;1;35;95mâ–„â–„[0;1;31;91mâ–„[0m  "
  echo -e "[0;1;32;92mâ–ˆ[0m [0;1;36;96mâ–ˆ[0;1;34;94mâ–ˆ[0m [0;1;35;95mâ–ˆ[0m [0;1;31;91mâ–ˆâ–€[0m [0;1;33;93mâ–€[0;1;32;92mâ–ˆ[0m   [0;1;34;94mâ–ˆâ–€[0m  [0;1;31;91mâ–€[0m [0;1;33;93mâ–ˆâ–€[0m  [0;1;36;96mâ–ˆ[0m  [0;1;34;94mâ–€[0m   [0;1;31;91mâ–ˆ[0m  [0;1;32;92mâ–ˆâ–€[0m  [0;1;34;94mâ–ˆ[0m  [0;1;35;95mâ–ˆ[0;1;31;91mâ–€[0m [0;1;33;93mâ–€â–ˆ[0m "
  echo -e "[0;1;36;96mâ–ˆ[0m [0;1;34;94mâ–€[0;1;35;95mâ–€[0m [0;1;31;91mâ–ˆ[0m [0;1;33;93mâ–ˆ[0m   [0;1;36;96mâ–ˆ[0m   [0;1;35;95mâ–ˆ[0m     [0;1;32;92mâ–ˆâ–€[0;1;36;96mâ–€â–€[0;1;34;94mâ–€[0m  [0;1;35;95mâ–„[0;1;31;91mâ–€â–€[0;1;33;93mâ–€â–ˆ[0m  [0;1;36;96mâ–ˆ[0m   [0;1;35;95mâ–ˆ[0m  [0;1;31;91mâ–ˆ[0m   [0;1;32;92mâ–ˆ[0m "
  echo -e "[0;1;34;94mâ–ˆ[0m    [0;1;33;93mâ–ˆ[0m [0;1;32;92mâ–€â–ˆ[0;1;36;96mâ–„â–ˆ[0;1;34;94mâ–€[0m   [0;1;31;91mâ–ˆ[0m     [0;1;36;96mâ–€â–ˆ[0;1;34;94mâ–„â–„[0;1;35;95mâ–€[0m  [0;1;31;91mâ–€[0;1;33;93mâ–„â–„[0;1;32;92mâ–€â–ˆ[0m  [0;1;34;94mâ–ˆ[0m   [0;1;31;91mâ–ˆ[0m  [0;1;33;93mâ–ˆ[0;1;32;92mâ–ˆâ–„[0;1;36;96mâ–ˆâ–€[0m "
  echo -e "                                           [0;1;32;92mâ–ˆ[0m     "
  echo -e "                                           [0;1;36;96mâ–€[0m     "
  echo
  echo -e "                                  Powered by Moreanp     "
  echo -e " -------------------------------------------------------"

  # åŠ¨æ€ä¿¡æ¯
  printf " CPU: %-7s | MEM: %-7s | DISK: %-6s | IP: %s\n" "$CPU" "$MEM" "$DISK" "$IP"
  echo -e " -------------------------------------------------------"

  # æ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡
  sleep 3
done
EOF

chmod +x "$BANNER_PATH"
echo -e "\033[1;32mâœ… Banner è„šæœ¬å·²ç”Ÿæˆï¼š$BANNER_PATH\033[0m"

# =========================================================
# 2) æ³¨å†Œç™»å½•è‡ªåŠ¨æ‰§è¡Œ
# =========================================================
if ! grep -q "moreanp_banner.sh" ~/.bashrc; then
    echo -e "\n# >>> Moreanp åŠ¨æ€ Banner <<<" >> ~/.bashrc
    echo "bash $BANNER_PATH" >> ~/.bashrc
    echo "# >>> End <<<" >> ~/.bashrc
    echo -e "\033[1;32mâœ… å·²æ³¨å†Œç™»å½•è‡ªåŠ¨æ˜¾ç¤º Banner\033[0m"
else
    echo -e "\033[1;33mâš ï¸ ç™»å½•è‡ªåŠ¨æ˜¾ç¤ºå·²å­˜åœ¨ï¼Œæ— éœ€é‡å¤æ·»åŠ \033[0m"
fi

# =========================================================
# 3) ç¦ç”¨ MOTD ä¸ SSH Banner
# =========================================================
for f in /etc/pam.d/sshd /etc/pam.d/login; do
  [ -f "$f" ] && sudo sed -i 's/^\(session\s\+optional\s\+pam_motd.so.*\)$/# \1/' "$f"
done
[ -d /etc/update-motd.d ] && sudo chmod -x /etc/update-motd.d/* 2>/dev/null
[ -f /etc/motd ] && sudo mv /etc/motd /etc/motd.disabled 2>/dev/null

for cfg in /etc/ssh/sshd_config /etc/ssh/ssh_config; do
  if [ -f "$cfg" ]; then
    sudo sed -i 's/^[# ]*Banner.*/# Banner none/' "$cfg"
    if ! grep -q '^# Banner none' "$cfg"; then
      echo "# Banner none" | sudo tee -a "$cfg" >/dev/null
    fi
  fi
done

echo -e "\033[1;36mâ†’ å®‰è£…å®Œæˆï¼ä¸‹æ¬¡ç™»å½•è‡ªåŠ¨æ˜¾ç¤ºå®æ—¶åŠ¨æ€ Banner\033[0m"
echo -e "\033[1;35m(å¯ç«‹å³æµ‹è¯•ï¼šbash $BANNER_PATH)\033[0m"
